<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Chat Test</title>
  <script src="https://crossway-chat-server-production.up.railway.app/socket.io/socket.io.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #messages {
      border: 1px solid #ccc;
      height: 250px;
      overflow-y: auto;
      padding: 10px;
      margin-bottom: 10px;
      background: #f8fafc;
    }
    #messages .msg {
      padding: 4px 6px;
      margin-bottom: 4px;
      border-radius: 4px;
      background: #ffffff;
    }
    #unreadBadge {
      font-size: 0.9rem;
      font-weight: 600;
      color: #c0392b;
      margin-left: 8px;
      display: none;
    }
    .controls {
      margin-top: 8px;
    }
    label {
      font-size: 0.9rem;
      margin-right: 4px;
    }
  </style>
</head>
<body>
  <h2>Chat Test Page <span id="unreadBadge"></span></h2>

  <div class="controls">
    <label for="nameInput">Name:</label>
    <input id="nameInput" type="text" placeholder="Your name" />
  </div>

  <div id="messages"></div>

  <div class="controls">
    <input id="msgInput" type="text" placeholder="Type messageâ€¦" style="width: 70%;" />
    <button id="sendBtn">Send</button>
  </div>

  <script>
    const socket = io("https://crossway-chat-server-production.up.railway.app");

    const messagesEl = document.getElementById("messages");
    const nameInput = document.getElementById("nameInput");
    const msgInput = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");
    const unreadBadge = document.getElementById("unreadBadge");

    let unreadCount = 0;
    let windowFocused = true;

    // ðŸ” Restore name from localStorage on load
    const STORED_NAME_KEY = "crossway_chat_name";
    const storedName = localStorage.getItem(STORED_NAME_KEY);
    if (storedName) {
      nameInput.value = storedName;
    }

    // ðŸ”” Update unread badge
    function updateUnreadBadge() {
      if (unreadCount > 0) {
        unreadBadge.style.display = "inline";
        unreadBadge.textContent = `(${unreadCount} new)`;
      } else {
        unreadBadge.style.display = "none";
      }
    }

    // ðŸ§¹ Mark all as read
    function markAllRead() {
      unreadCount = 0;
      updateUnreadBadge();
    }

    // Track window focus for notifications
    window.addEventListener("focus", () => {
      windowFocused = true;
      markAllRead();
    });
    window.addEventListener("blur", () => {
      windowFocused = false;
    });

    // Also clear unread when user scrolls to bottom
    messagesEl.addEventListener("scroll", () => {
      const nearBottom =
        messagesEl.scrollTop + messagesEl.clientHeight >= messagesEl.scrollHeight - 5;
      if (nearBottom) {
        markAllRead();
      }
    });

    // Socket events
    socket.on("connect", () => {
      console.log("Connected to chat server", socket.id);
    });

    socket.on("chatMessage", (msg) => {
      const div = document.createElement("div");
      div.className = "msg";
      div.textContent = `${msg.name}: ${msg.text}`;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;

      // Only count as unread if window not focused
      if (!windowFocused) {
        unreadCount++;
        updateUnreadBadge();
      }
    });

    socket.on("chatCleared", () => {
      messagesEl.innerHTML = "";
      markAllRead();
      const info = document.createElement("div");
      info.className = "msg";
      info.style.fontStyle = "italic";
      info.textContent = "Chat history was cleared by the server.";
      messagesEl.appendChild(info);
    });

    function sendMessage() {
      const name = nameInput.value.trim() || "Anonymous";
      const text = msgInput.value.trim();
      if (!text) return;

      // Remember name across refreshes
      localStorage.setItem(STORED_NAME_KEY, name);

      socket.emit("chatMessage", { name, text });

      msgInput.value = "";
      msgInput.focus();
    }

    sendBtn.addEventListener("click", sendMessage);
    msgInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendMessage();
      }
    });
  </script>
</body>
</html>
